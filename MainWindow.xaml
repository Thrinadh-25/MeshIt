<Window x:Class="meshIt.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="clr-namespace:meshIt.Views"
        Title="meshIt â€” BLE Mesh Messenger v3"
        Width="1200" Height="720"
        MinWidth="960" MinHeight="520"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource PrimaryBackground}"
        AllowDrop="True" Drop="Window_Drop" DragOver="Window_DragOver" DragLeave="Window_DragLeave">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="260"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="280"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="32"/>
        </Grid.RowDefinitions>

        <!-- ===== Left Sidebar ===== -->
        <Border Grid.Column="0" Grid.Row="0"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="160"/>
                </Grid.RowDefinitions>

                <!-- Identity header (tap 3x for emergency wipe) -->
                <Border Grid.Row="0" Background="{DynamicResource TertiaryBackground}"
                        Padding="16,12" Cursor="Hand"
                        MouseLeftButtonUp="IdentityHeader_Click">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="ðŸ”" FontSize="18"
                                   VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="{Binding Username}" FontSize="14" FontWeight="SemiBold"
                                       Foreground="{DynamicResource PrimaryText}"/>
                            <TextBlock Text="{Binding ShortFingerprint}" FontSize="11"
                                       FontFamily="Consolas" Foreground="{DynamicResource AccentBrush}"/>
                        </StackPanel>
                        <TextBlock Grid.Column="2" Text="â€º" FontSize="18"
                                   Foreground="{DynamicResource MutedText}" VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- Peer list -->
                <views:PeerListView Grid.Row="1" DataContext="{Binding}"/>

                <Border Grid.Row="2" Height="1" Background="{DynamicResource DividerBrush}"/>

                <!-- Channel list -->
                <views:ChannelView Grid.Row="3" DataContext="{Binding ChannelListVm}"/>
            </Grid>
        </Border>

        <!-- ===== Center: Chat ===== -->
        <views:ChatView Grid.Column="1" Grid.Row="0" DataContext="{Binding}"/>

        <!-- ===== Right: File transfers + toolbar ===== -->
        <Border Grid.Column="2" Grid.Row="0"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1,0,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Right panel toolbar -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="12,10"
                            HorizontalAlignment="Right">
                    <Button Content="ðŸ“Š" ToolTip="Diagnostics" FontSize="16"
                            Command="{Binding ToggleDiagnosticsCommand}"
                            Background="Transparent" BorderThickness="0"
                            Foreground="{DynamicResource SecondaryText}" Cursor="Hand"
                            Padding="6,4" Margin="2,0"/>
                    <Button Content="âš™ï¸" ToolTip="Settings" FontSize="16"
                            Command="{Binding ToggleSettingsCommand}"
                            Background="Transparent" BorderThickness="0"
                            Foreground="{DynamicResource SecondaryText}" Cursor="Hand"
                            Padding="6,4" Margin="2,0"/>
                    <Button Content="ðŸ’¾" ToolTip="Export Backup" FontSize="16"
                            Command="{Binding ExportBackupCommand}"
                            Background="Transparent" BorderThickness="0"
                            Foreground="{DynamicResource SecondaryText}" Cursor="Hand"
                            Padding="6,4" Margin="2,0"/>
                </StackPanel>

                <views:FileTransferView Grid.Row="1" DataContext="{Binding}"/>
            </Grid>
        </Border>

        <!-- ===== Overlays (Panel.ZIndex for stacking) ===== -->

        <!-- Settings overlay -->
        <Border Grid.Column="1" Grid.Row="0" Panel.ZIndex="10"
                Visibility="{Binding IsSettingsOpen, Converter={StaticResource BoolToVis}}"
                Background="{DynamicResource PrimaryBackground}">
            <views:SettingsView DataContext="{Binding SettingsVm}"/>
        </Border>

        <!-- Identity overlay -->
        <Border Grid.Column="1" Grid.Row="0" Panel.ZIndex="11"
                Visibility="{Binding IsIdentityOpen, Converter={StaticResource BoolToVis}}"
                Background="{DynamicResource PrimaryBackground}">
            <views:IdentityView DataContext="{Binding IdentityVm}"/>
        </Border>

        <!-- Diagnostics overlay -->
        <Border Grid.Column="1" Grid.Row="0" Panel.ZIndex="12"
                Visibility="{Binding IsDiagnosticsOpen, Converter={StaticResource BoolToVis}}"
                Background="{DynamicResource PrimaryBackground}">
            <views:DiagnosticsView DataContext="{Binding DiagnosticsVm}"/>
        </Border>

        <!-- Drag-drop overlay -->
        <Border Grid.Column="0" Grid.ColumnSpan="3" Grid.Row="0" Panel.ZIndex="20"
                Background="#CC0F0F23"
                Visibility="{Binding IsDragOver, Converter={StaticResource BoolToVis}}"
                IsHitTestVisible="False">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="ðŸ“" FontSize="64" HorizontalAlignment="Center"/>
                <TextBlock Text="Drop files to send" FontSize="20" FontWeight="SemiBold"
                           Foreground="#E0E0E0" HorizontalAlignment="Center" Margin="0,12,0,0"/>
            </StackPanel>
        </Border>

        <!-- ===== Status bar ===== -->
        <Border Grid.Column="0" Grid.ColumnSpan="3" Grid.Row="1"
                Background="{DynamicResource TertiaryBackground}" Padding="16,6">
            <Grid>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding StatusText}" FontSize="11"
                               Foreground="{DynamicResource DimText}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <!-- Voice record button -->
                    <Button Content="{Binding IsRecordingVoice, Converter={StaticResource BoolToVis}, FallbackValue=ðŸŽ¤}"
                            Command="{Binding ToggleVoiceRecordingCommand}"
                            Background="Transparent" BorderThickness="0" Cursor="Hand"
                            Foreground="{DynamicResource AccentBrush}" FontSize="14" Padding="6,2" Margin="4,0">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Content" Value="ðŸŽ¤"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderThickness" Value="0"/>
                            </Style>
                        </Button.Style>
                    </Button>
                    <TextBlock Text="ðŸ”" FontSize="9" Margin="0,0,4,0"
                               Foreground="{DynamicResource AccentBrush}"/>
                    <TextBlock FontSize="11" Foreground="{DynamicResource MutedText}">
                        <Run Text="meshIt v"/>
                        <Run Text="{Binding AppVersion, Mode=OneWay}"/>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
